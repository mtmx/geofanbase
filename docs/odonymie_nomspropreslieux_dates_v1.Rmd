---
title: "odonymie noms propres de lieux et dates"
author: "MG"
date: "7/11/2018"
output: markdowntemplates::skeleton
#image: "logos_clubs/SRFC.png"
weight: 0
type: "post"
description: "Version beta"
tags: ["odonymie", "lieux", "villes"]

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(data.table)
library(sf)
library(hrbrthemes)
library(ggthemes)
library(ggiraph)
library(ggimage)
library(COGugaison)
library(RColorBrewer)
library(ggrepel)
library(patchwork)
# sorties

COMM_nbvoies_LINP_1 <- fread( file = "./data_fantoir/COMM_nbvoies_LINP_1.csv", verbose = F)
COMM_nbvoies_DAT_1 <- fread( file = "./data_fantoir/COMM_nbvoies_DAT_1.csv", verbose = F)

COMM_nbvoies_LINP_1.tr <- COMM_nbvoies_LINP_1 %>% gather(nom_voie, nb, - CODE_DEPCOM) %>% mutate( nb =as.numeric(nb))
COMM_nbvoies_DAT_1.tr <- COMM_nbvoies_DAT_1 %>% gather(nom_voie, nb, - CODE_DEPCOM) %>% mutate( nb =as.numeric(nb))


cpt_DEPCOM_odonymes_VILLES.geo <- fread( file = "./data_fantoir/cpt_DEPCOM_odonymes_VILLES.geo.csv", verbose = F)
cpt_odonymes_VILLES <- fread( file = "./data_fantoir/cpt_odonymes_VILLES.csv", verbose = F)


# carto
dep <- st_read( "./data_fantoir/dep.shp")
# centroides
dep.ctr <- dep %>% st_centroid(of_largest_polygon = FALSE) %>%
  mutate(x_ctr = map_dbl(geometry, ~st_centroid(.x)[[1]]),
         y_ctr = map_dbl(geometry, ~st_centroid(.x)[[2]])) 



# fonction pour gérer accents
conv_accents <- function(x) {
  x <- gsub(pattern = "è", replacement = "&egrave;", x = x)
  x <- gsub(pattern = "é", replacement = "&eacute;", x = x)
  x <- gsub(pattern = "ê", replacement = "&ecirc;", x = x)
  x <- gsub(pattern = "ë", replacement = "&euml;", x = x)
  x <- gsub(pattern = "î", replacement = "&icirc;", x = x)
  x <- gsub(pattern = "ï", replacement = "&iuml;", x = x)
  x <- gsub(pattern = "û", replacement = "&ucirc;", x = x)
  x <- gsub(pattern = "ü", replacement = "&uuml;", x = x)
  x <- gsub(pattern = "ô", replacement = "&ocirc;", x = x)
  x <- gsub(pattern = "à", replacement = "&agrave;", x = x)
  x <- gsub(pattern = "â", replacement = "&acirc;", x = x)
  x <- gsub(pattern = "ç", replacement = "&ccedil;", x = x)
  
  x <- gsub(pattern = "è", replacement = "&Egrave;", x = x)
  x <- gsub(pattern = "é", replacement = "&Eacute;", x = x)
  x <- gsub(pattern = "ê", replacement = "&Ecirc;", x = x)
  x <- gsub(pattern = "ë", replacement = "&Euml;", x = x)
  x <- gsub(pattern = "î", replacement = "&Icirc;", x = x)
  x <- gsub(pattern = "ï", replacement = "&Iuml;", x = x)
  x <- gsub(pattern = "û", replacement = "&Ucirc;", x = x)
  x <- gsub(pattern = "ü", replacement = "&Uuml;", x = x)
  x <- gsub(pattern = "ô", replacement = "&Ocirc;", x = x)
  x <- gsub(pattern = "à", replacement = "&Agrave;", x = x)
  x <- gsub(pattern = "â", replacement = "&Acirc;", x = x)
  x <- gsub(pattern = "ç", replacement = "&Ccedil;", x = x)
  x <- gsub(pattern = "'", replacement = "&apos;", x = x)
  
  return(x)
}

```

## Analyse des noms de rue de lieux


```{r carte_LINP_dep_graphique,echo=F, message=F, warning=F ,fig.height=6,fig.width=9, include=TRUE}

TOT_nbvoies_LINP_1.tr <-
  COMM_nbvoies_LINP_1.tr %>%
  group_by(nom_voie) %>%
  summarise(nb = sum(nb)) %>%
  filter(!nom_voie %in% 'nb_voies') %>%
  mutate(nom_voie = str_replace_all(nom_voie,"nb_voies_","")) 

ggplot() +
  geom_label_repel(data = TOT_nbvoies_LINP_1.tr %>% filter(nb > 100), 
                   aes(x= nb, y = 1, label = nom_voie, size =  nb), 
                   angle = 0, label.size =  0, color = "white",#size = 2.5,
                   fill = "#4a16b0",
                   nudge_y = 0, segment.color = NA, fontface = "bold", box.padding = unit(0.05, "lines"), point.padding = unit(0.05, "lines")) +
  scale_x_continuous(name = "", breaks = c(150,250,500,1000,2000)) +
  scale_y_continuous(name ="",limits = c(0.2,1.8)) +
  coord_flip() +
  #scale_fill_distiller(palette = "Greens", direction = 1) +
  scale_size_continuous(range = c(1,8), guide = FALSE) +
  theme_ipsum() +
  annotate("text", x = 2000,y=0.3, label = "Noms de rues\nles plus fréquents",fontface="bold", family="Calibri", size =3, color ="#b2182b") +
  annotate("text", x = 200,y=0.3, label = "",fontface="bold", family="Calibri", size =3, color ="#2166ac") +
  geom_segment(aes(x = 300, y = 0.3, xend = 1900, yend = 0.3), colour='grey', size=0.6,arrow = arrow(length = unit(0.2, "cm"))) +
  labs(    title = "Odonymes les plus courants dans la catégorie 'Noms propres de lieux' ",
           #subtitle = "toute France",
           caption = "Source : Fantoir") +
  #theme_ipsum_rc(grid="XY") +
  #theme(axis.text.x=element_text(hjust=c(0, 0.5, 0.5, 0.5, 1))) +
  theme(legend.position=c(0.9,0.7), 
        axis.text.x = element_blank(), axis.line.x = element_blank(),axis.ticks.x=element_blank(),
        panel.grid.minor= element_blank(),panel.grid.major.x= element_blank())
          
```


bla bla :


```{r carte_LINP_dep_max,echo=F, message=F, warning=F ,fig.height=7,fig.width=9, include=TRUE}


DEP_nbvoies_LINP_1.max <- COMM_nbvoies_LINP_1.tr %>%
  mutate(CODGEO =  case_when(substr(CODE_DEPCOM,1,2) %in% '75'~ "75056",
                             substr(CODE_DEPCOM,1,3) %in% '132'~ "13055",
                             substr(CODE_DEPCOM,1,4) %in% '6938'~ "69123", TRUE ~ as.character(CODE_DEPCOM)) ) %>%
  left_join(table_supracom_2016 %>% dplyr::select(CODGEO, DEP), by = "CODGEO")  %>%
  ungroup() %>%
  group_by(DEP, nom_voie) %>%
  summarise(nb = sum(nb)) %>%
  filter(!nom_voie %in% 'nb_voies') %>%
  top_n(n=1) %>%
  distinct(DEP, nb, .keep_all = TRUE) %>%
  mutate(nom_voie = str_replace_all(nom_voie,"nb_voies_",""))



ggplot() +
  # contours departements
  geom_sf(data = dep %>%
            left_join(DEP_nbvoies_LINP_1.max , by = c("DEP") ),
          aes(fill = nom_voie), color = "grey90", stroke = 0.5) +
  geom_text(data = dep.ctr %>%
                left_join(DEP_nbvoies_LINP_1.max , by = c("DEP") ),
                         aes(x = x_ctr, y = y_ctr,size = nb, label = nom_voie ),
                         size = 2,  show.legend = FALSE) +
  scale_fill_manual(guide=FALSE, name = "",values =   colorRampPalette(brewer.pal(12, "Paired"))(cpt_DEPCOM_odonymes_VILLES.geo %>% ungroup() %>% distinct(NOM_COMM) %>% nrow())) +
  scale_x_continuous(name = "") +
  scale_y_continuous(name = "") +
  coord_sf(crs = 2154, datum = NA) +
  theme_fivethirtyeight() +
  theme(axis.text = element_blank(),
        legend.box = "vertical",
        legend.position = "right",
        panel.grid = element_line(size = 0),
        panel.background = element_rect(fill = NA),
        text = element_text(family="Helvetica")) +
  labs(
    title = "Odonyme majoritaire dans la catégorie 'Noms propres de lieux' ",
    subtitle = "par département",
    caption = "Source : Fantoir"
  ) 

          
```


<br>

### Les rues des lieux dans le détail

bla bla :

```{r carte_LINP_idw_1,echo=F, message=F, warning=F ,fig.height=2.5,fig.width=9, include=TRUE}

library(png)
library(grid)
library(gridExtra)
img1 <-  rasterGrob(as.raster(readPNG("./img_func/LINP_1/nb_voies_VERDUN.png")), interpolate = FALSE)
img2 <-  rasterGrob(as.raster(readPNG("./img_func/LINP_1/nb_voies_EUROPE.png")), interpolate = FALSE)
img3 <-  rasterGrob(as.raster(readPNG("./img_func/LINP_1/nb_voies_VARENNES.png")), interpolate = FALSE)
#img4 <-  rasterGrob(as.raster(readPNG("./img_func/LINP_1/nb_voies_LYON.png")), interpolate = FALSE)
grid.arrange(img1, img2, img3,  ncol = 4)



```


bla bla :

```{r carte_LINP_idw_2,echo=F, message=F, warning=F ,fig.height=2.5,fig.width=9, include=TRUE}

img1 <-  rasterGrob(as.raster(readPNG("./img_func/LINP_1/nb_voies_PYRENEES.png")), interpolate = FALSE)
img2 <-  rasterGrob(as.raster(readPNG("./img_func/LINP_1/nb_voies_ALPES.png")), interpolate = FALSE)
img3 <-  rasterGrob(as.raster(readPNG("./img_func/LINP_1/nb_voies_VOSGES.png")), interpolate = FALSE)
img4 <-  rasterGrob(as.raster(readPNG("./img_func/LINP_1/nb_voies_DAUPHINE.png")), interpolate = FALSE)
grid.arrange(img1, img2, img3, img4, ncol = 4)

img1 <-  rasterGrob(as.raster(readPNG("./img_func/LINP_1/nb_voies_SAVOIE.png")), interpolate = FALSE)
img2 <-  rasterGrob(as.raster(readPNG("./img_func/LINP_1/nb_voies_PERCHE.png")), interpolate = FALSE)
img3 <-  rasterGrob(as.raster(readPNG("./img_func/LINP_1/nb_voies_GASCOGNE.png")), interpolate = FALSE)
img4 <-  rasterGrob(as.raster(readPNG("./img_func/LINP_1/nb_voies_VERCORS.png")), interpolate = FALSE)
grid.arrange(img1, img2, img3, img4, ncol = 4)

img1 <-  rasterGrob(as.raster(readPNG("./img_func/LINP_1/nb_voies_BRETAGNE.png")), interpolate = FALSE)
img2 <-  rasterGrob(as.raster(readPNG("./img_func/LINP_1/nb_voies_PROVENCE.png")), interpolate = FALSE)
img3 <-  rasterGrob(as.raster(readPNG("./img_func/LINP_1/nb_voies_ALSACE.png")), interpolate = FALSE)
img4 <-  rasterGrob(as.raster(readPNG("./img_func/LINP_1/nb_voies_LORRAINE.png")), interpolate = FALSE)
grid.arrange(img1, img2, img3, img4, ncol = 4)

img1 <-  rasterGrob(as.raster(readPNG("./img_func/LINP_1/nb_voies_CHAMPAGNE.png")), interpolate = FALSE)
img2 <-  rasterGrob(as.raster(readPNG("./img_func/LINP_1/nb_voies_CEVENNES.png")), interpolate = FALSE)
img3 <-  rasterGrob(as.raster(readPNG("./img_func/LINP_1/nb_voies_BOURGOGNE.png")), interpolate = FALSE)
img4 <-  rasterGrob(as.raster(readPNG("./img_func/LINP_1/nb_voies_ANJOU.png")), interpolate = FALSE)
grid.arrange(img1, img2, img3, img4, ncol = 4)

img1 <-  rasterGrob(as.raster(readPNG("./img_func/LINP_1/nb_voies_NORMANDIE.png")), interpolate = FALSE)
img2 <-  rasterGrob(as.raster(readPNG("./img_func/LINP_1/nb_voies_MIDI.png")), interpolate = FALSE)
img3 <-  rasterGrob(as.raster(readPNG("./img_func/LINP_1/nb_voies_LANGUEDOC.png")), interpolate = FALSE)
img4 <-  rasterGrob(as.raster(readPNG("./img_func/LINP_1/nb_voies_PICARDIE.png")), interpolate = FALSE)
grid.arrange(img1, img2, img3, img4, ncol = 4)


```


bla bla :

```{r carte_LINP_idw_3,echo=F, message=F, warning=F ,fig.height=2.5,fig.width=9, include=TRUE}

img1 <-  rasterGrob(as.raster(readPNG("./img_func/LINP_1/nb_voies_MARNE.png")), interpolate = FALSE)
img2 <-  rasterGrob(as.raster(readPNG("./img_func/LINP_1/nb_voies_LOIRE.png")), interpolate = FALSE)
img3 <-  rasterGrob(as.raster(readPNG("./img_func/LINP_1/nb_voies_SEINE.png")), interpolate = FALSE)
img4 <-  rasterGrob(as.raster(readPNG("./img_func/LINP_1/nb_voies_RHONE.png")), interpolate = FALSE)
grid.arrange(img1, img2, img3, img4, ncol = 4)


img1 <-  rasterGrob(as.raster(readPNG("./img_func/LINP_1/nb_voies_SAINTONGE.png")), interpolate = FALSE)
img2 <-  rasterGrob(as.raster(readPNG("./img_func/LINP_1/nb_voies_CANADIENS.png")), interpolate = FALSE)
img3 <-  rasterGrob(as.raster(readPNG("./img_func/LINP_1/nb_voies_VENDEE.png")), interpolate = FALSE)
img4 <-  rasterGrob(as.raster(readPNG("./img_func/LINP_1/nb_voies_POITOU.png")), interpolate = FALSE)
grid.arrange(img1, img2, img3, img4, ncol = 4)

```



Meta-odonymie : les noms de rues de villes


```{r carte_meta_odo,echo=F, message=F, warning=F ,fig.height=8,fig.width=9, include=FALSE}


#############
### ggiraph

library(ggiraph)



my_gg <-
ggplot() +
  #geom_sf(data =st_cast(ref_SW_selection.NED ,"MULTIPOLYGON"), color = "grey80", size = 0.1) +
  geom_sf(data =dep , color = "grey80", size = 0.1) +
  # avec geom_curve
  geom_segment_interactive(data=cpt_DEPCOM_odonymes_VILLES.geo %>%
                 #filter(NOM_COMM %in% c('RENNES','VANNES', 'QUIMPER')) %>%
                 filter(CODGEO != CODE_DEPCOM_PLM),
               aes(x=x_ctr.CODGEO, y=y_ctr.CODGEO,
                   xend=x_ctr.CODE_DEPCOM_PLM, yend=y_ctr.CODE_DEPCOM_PLM,
                   #color = NOM_COMM, 
                   data_id = NOM_COMM,
                   tooltip = NOM_COMM),
               guides = FALSE, 
               size = 0.2,
               color =NA,
               alpha = 0.2,
               #arrow = arrow(length = unit(0.03, "npc"),
               curvature = 0.1) +
  geom_point_interactive(data=cpt_DEPCOM_odonymes_VILLES.geo %>%
               #filter(NOM_COMM %in% c('RENNES','VANNES', 'QUIMPER')) %>%
               filter(CODGEO != CODE_DEPCOM_PLM),
             aes(x=x_ctr.CODE_DEPCOM_PLM, y=y_ctr.CODE_DEPCOM_PLM,
                 #color = NOM_COMM,
                 data_id = NOM_COMM,
                 tooltip = NOM_COMM),
             guides = FALSE,
             alpha = 0.2,
             color ="grey",
             stroke = 0,
             size = 0.3) +

  
  # gros points sur villes
  geom_point_interactive(data=cpt_DEPCOM_odonymes_VILLES.geo %>%
                           distinct(CODGEO, .keep_all = TRUE) ,
                         aes(x=x_ctr.CODGEO, y=y_ctr.CODGEO,
                             #color = NOM_COMM, 
                             data_id = NOM_COMM,
                             tooltip = NOM_COMM),
                         guides = FALSE, 
                         alpha = 0.2,
                         color ="grey60",
                         stroke = 0,
                         size = 3) +
  scale_alpha(range = c(0.4,1),guide =F) +
  scale_color_manual(guide=FALSE, name = "",values =  colorRampPalette(brewer.pal(12, "Paired"))(cpt_DEPCOM_odonymes_VILLES.geo %>% ungroup() %>% distinct(NOM_COMM) %>% nrow())) +
  
  # geom_text(data=cpt_DEPCOM_odonymes_VILLES.geo %>%
  #             #filter(NOM_COMM %in% 'QUIMPER') %>%
  #             distinct(NOM_COMM) ,
  #           aes(x=1084717, y=7039044, label = NOM_COMM), 
  #               color = "black", size = 4) +
  scale_size(name="nb",range = c(0.15,1.2)) +
  #scale_size(name="nb",range = c(0.4,2.8)) +
  #scale_color_discrete(guide =F) +
  scale_x_continuous(name = "") +
  scale_y_continuous(name = "") +
  # scale_x_continuous(name = "", limits = c(-845702.3,3537411.5)) +
  # scale_y_continuous(name = "", limits = c(3303244.2,6977360.5)) +
  theme_economist_white() +
  coord_sf( datum = NA) +
  labs(
    title = "Odonymes des principales villes de France",
    subtitle="Localisation des communes ayant des noms de rues y faisant référence",
    caption="source : Fantoir"
  )

x <- girafe(code = print(my_gg))
x <- girafe_options(x,
      opts_hover(css = "fill:red;r:2.5pt;size:5pt;stroke:red;color:black;opacity:0.3") ,
      #opts_hover(css = "fill:black;r:0.25pt;size:5;stroke:black") ,
      opts_tooltip(use_fill = FALSE) , 
      opts_toolbar(saveaspng = FALSE) )

x



```


```{r carte_meta_odo_v2,echo=F, message=F, warning=F ,fig.height=8,fig.width=9, include=TRUE}

gg_carte <-
ggplot() +
  geom_sf(data =dep , color = "grey80",fill = NA, size = 0.1) +

  # avec geom_curve
  geom_segment_interactive(data=cpt_DEPCOM_odonymes_VILLES.geo %>%
                 #filter(NOM_COMM %in% c('RENNES','VANNES', 'QUIMPER')) %>%
                 filter(CODGEO != CODE_DEPCOM_PLM),
               aes(x=x_ctr.CODGEO, y=y_ctr.CODGEO,
                   xend=x_ctr.CODE_DEPCOM_PLM, yend=y_ctr.CODE_DEPCOM_PLM,
                   #color = NOM_COMM,
                   data_id = NOM_COMM,
                   tooltip = NOM_COMM),
               guides = FALSE,
               size = 0.25,
               color = NA,
               alpha = 0.2,
               #arrow = arrow(length = unit(0.03, "npc"),
               curvature = 0.1) +
  geom_point_interactive(data=cpt_DEPCOM_odonymes_VILLES.geo %>%
                           #filter(NOM_COMM %in% c('RENNES','VANNES', 'QUIMPER')) %>%
                           filter(CODGEO != CODE_DEPCOM_PLM),
                         aes(x=x_ctr.CODE_DEPCOM_PLM, y=y_ctr.CODE_DEPCOM_PLM,
                             #color = NOM_COMM,
                             data_id = NOM_COMM,
                             tooltip = NOM_COMM),
                         guides = FALSE,
                         alpha = 0,
                         color = "grey",
                         stroke = 0.5,
                         size = 0) +
  # gros points sur villes
  geom_point_interactive(data=cpt_DEPCOM_odonymes_VILLES.geo %>%
                           distinct(CODGEO, .keep_all = TRUE) ,
                         aes(x=x_ctr.CODGEO, y=y_ctr.CODGEO,
                             #color = NOM_COMM, 
                             data_id = NOM_COMM,
                             tooltip = NOM_COMM),
                         guides = FALSE, 
                         alpha = 0.2,
                         color ="grey60",
                         stroke = 0,
                         size = 3) +
  scale_alpha(range = c(0.4,1),guide =F) +
  scale_color_manual(guide=FALSE, name = "",values =  colorRampPalette(brewer.pal(10, "Paired"))(cpt_DEPCOM_odonymes_VILLES.geo %>% ungroup() %>% distinct(NOM_COMM) %>% nrow())) +
  # geom_text(data=cpt_DEPCOM_odonymes_VILLES.geo %>%
  #             #filter(NOM_COMM %in% 'QUIMPER') %>%
  #             distinct(NOM_COMM) ,
  #           aes(x=1084717, y=7039044, label = NOM_COMM), 
  #               color = "black", size = 4) +
  scale_size(name="nb",range = c(0.15,1.2)) +
  #scale_size(name="nb",range = c(0.4,2.8)) +
  #scale_color_discrete(guide =F) +
  scale_x_continuous(name = "") +
  scale_y_continuous(name = "") +
  # scale_x_continuous(name = "", limits = c(-845702.3,3537411.5)) +
  # scale_y_continuous(name = "", limits = c(3303244.2,6977360.5)) +
  theme_economist_white() +
  # theme(plot.title = element_text(face="bold", family="Calibri"),
  #       plot.subtitle = element_text(title = element_text( family="Calibri")),
  #       plot.caption = element_text(title = element_text( family="Calibri"))
  #       ) +
  theme(plot.title = element_text(face="bold")
    ) +
  coord_sf( datum = NA) +
  labs(
    title = "Odonymes des principales villes de France",
    subtitle="Localisation des communes ayant des noms de rues y faisant référence",
    caption="source : Fantoir"
  )

# version graphique barres
gg_stat <-
ggplot(data = cpt_odonymes_VILLES %>%
         rename(NOM_COMM = lib_voie_simp) %>%
         arrange(desc(nb))) +
  # contours departements
  geom_bar_interactive(aes(x=reorder(NOM_COMM, nb),y=nb, #fill = type_ANIM,
               data_id = NOM_COMM,
               tooltip = NOM_COMM), 
           color = "grey20",
           fill = "grey60",
           stroke = 0.2,
           stat = "identity") +
  # text
  geom_text(aes(x=reorder(NOM_COMM, nb),y=nb+10,label=NOM_COMM),
            size = 1.8,
            position=position_dodge(width=0.9), hjust=0) +
  scale_y_continuous(name = "Nombre de rues portant ce nom", limits = c(0,1300)) +
  scale_x_discrete(name = "") +
  scale_fill_manual( name = "Type d'animaux : ", values = c("#335667", "#B3D2EE","#489be7")) +
  theme_fivethirtyeight() +
    # theme(plot.title = element_text(face="bold", family="Calibri"),
    #     plot.subtitle = element_text(title = element_text( family="Calibri")),
    #     plot.caption = element_text(title = element_text( family="Calibri"))
    #     ) +
      theme(plot.title = element_text(face="bold")
        ) +
  coord_flip() +
  
  theme(axis.text.y = element_blank(),
        legend.position = c(0.6,0.2),
        panel.grid.major.y = element_blank(),
        panel.grid = element_line(size = 0),
        panel.background = element_rect(fill = NA),
        text = element_text(family="Helvetica")) +
  labs(
    title = "",
    subtitle = ""#,
    #caption = "Source : Fantoir"
  ) 


#girafe( code = print(my_gg + gg_stat), width_svg = 8, height_svg = 4)
x <- girafe( code = print(gg_carte + gg_stat + plot_layout(nrow  = 1, widths  = c(3, 1)) ), width_svg = 8, height_svg = 6.5)
x <- girafe_options(x,
                    opts_hover(css = "fill:red;r:2.5pt;size:5pt;stroke:red;color:black;opacity:0.3") ,
                    #opts_hover(css = "fill:black;r:0.25pt;size:5;stroke:black") ,
                    opts_tooltip(use_fill = FALSE) , 
                    opts_toolbar(saveaspng = FALSE) )

x

```


## Analyse Dates


```{r carte_DAT_dep_graphique,echo=F, message=F, warning=F ,fig.height=2,fig.width=7, include=TRUE}

TOT_nbvoies_DAT_1.tr <-
  COMM_nbvoies_DAT_1.tr %>%
  group_by(nom_voie) %>%
  summarise(nb = sum(nb)) %>%
  filter(!nom_voie %in% 'nb_voies') %>%
  mutate(nom_voie = str_replace_all(nom_voie,"nb_voies_","")) 

ggplot(data = TOT_nbvoies_DAT_1.tr %>%
         arrange(desc(nb)) %>%
         slice(1 : 43 )) +
  geom_bar(aes(x=reorder(nom_voie, nb),y=nb), 
           color = "grey90", stroke = 0.5, 
           fill = "#e31010",
           stat = "identity") +
  # text
  geom_text(aes(x=reorder(nom_voie, nb),y=nb+10,label=nom_voie),
            size = 2.5,
            position=position_dodge(width=0.9), hjust=0) +
  scale_y_continuous(name = "Nombre de rues portant ce nom", limits = c(0,5000)) +
  scale_x_discrete(name = "") +
  theme_fivethirtyeight() +
  coord_flip() +
  
  theme(axis.text.y = element_blank(),
        legend.position = c(0.6,0.2),
        panel.grid.major.y = element_blank(),
        panel.grid = element_line(size = 0),
        panel.background = element_rect(fill = NA),
        text = element_text(family="Helvetica")) +
  labs(
    title = "Odonymes les plus courants dans la catégorie 'Dates' ",
    subtitle = "toute France",
    caption = ""
  ) 


          
```



bla bla :


```{r carte_DAT_dep_max,echo=F, message=F, warning=F ,fig.height=7,fig.width=9, include=TRUE}
library(RColorBrewer)

DEP_nbvoies_DAT_1.max <- COMM_nbvoies_DAT_1.tr %>%
  mutate(CODGEO =  case_when(substr(CODE_DEPCOM,1,2) %in% '75'~ "75056",
                             substr(CODE_DEPCOM,1,3) %in% '132'~ "13055",
                             substr(CODE_DEPCOM,1,4) %in% '6938'~ "69123", TRUE ~ as.character(CODE_DEPCOM)) ) %>%
  left_join(table_supracom_2016 %>% dplyr::select(CODGEO, DEP), by = "CODGEO")  %>%
  ungroup() %>%
  group_by(DEP, nom_voie) %>%
  summarise(nb = sum(nb)) %>%
  filter(!nom_voie %in% 'nb_voies') %>%
  top_n(n=1) %>%
  distinct(DEP, nb, .keep_all = TRUE) %>%
  mutate(nom_voie = str_replace_all(nom_voie,"nb_voies_",""))


ggplot() +
  # contours departements
  geom_sf(data = dep %>%
            left_join(DEP_nbvoies_DAT_1.max , by = c("DEP") ),
          aes(fill = nom_voie), color = "grey90", stroke = 0.5) +
  geom_text(data = dep.ctr %>%
                left_join(DEP_nbvoies_DAT_1.max , by = c("DEP") ),
                         aes(x = x_ctr, y = y_ctr,size = nb, label = nom_voie ),
                         size = 2,  show.legend = FALSE) +
  scale_fill_manual(guide=FALSE, name = "",values =  colorRampPalette(brewer.pal(8, "Set2"))(DEP_nbvoies_DAT_1.max %>% ungroup() %>% distinct(nom_voie) %>% nrow())) +
  scale_x_continuous(name = "") +
  scale_y_continuous(name = "") +
  coord_sf(crs = 2154, datum = NA) +
  theme_fivethirtyeight() +
  theme(axis.text = element_blank(),
        legend.position = "right",
        legend.box = "vertical",
        panel.grid = element_line(size = 0),
        panel.background = element_rect(fill = NA),
        text = element_text(family="Helvetica")) +
  labs(
    title = "Odonyme majoritaire dans la catégorie 'Dates' ",
    subtitle = "par département",
    caption = "Source : Fantoir"
  ) 

          
```


### Les rues de dates dans le détail



```{r carte_DAT_idw,echo=F, message=F, warning=F ,fig.height=2.5,fig.width=9, include=TRUE}

library(png)
library(grid)
library(gridExtra)
img1 <-  rasterGrob(as.raster(readPNG("./img_func/DAT_1/nb_voies_8_MAI_1945.png")), interpolate = FALSE)
img2 <-  rasterGrob(as.raster(readPNG("./img_func/DAT_1/nb_voies_ONZE_NOVEMBRE.png")), interpolate = FALSE)
grid.arrange(img1, img2,  ncol = 4)



img1 <-  rasterGrob(as.raster(readPNG("./img_func/DAT_1/nb_voies_14_JUILLET.png")), interpolate = FALSE)
img2 <-  rasterGrob(as.raster(readPNG("./img_func/DAT_1/nb_voies_19_MARS_1962.png")), interpolate = FALSE)
img3 <-  rasterGrob(as.raster(readPNG("./img_func/DAT_1/nb_voies_QUATRE_SEPTEMBRE.png")), interpolate = FALSE)
grid.arrange(img1, img2, img3, ncol = 4)




```
